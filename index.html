<!DOCTYPE html>
<html lang="kn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>City Clinic Token Display</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      color: white;
    }

    body::before {
      content: "";
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(-45deg, #53d0d2, #128f91, #2e3c77, #3e629b);
      background-size: 400% 400%;
      animation: gradientFlow 30s ease infinite;
      z-index: -3;
    }

    @keyframes gradientFlow {
      0% {background-position: 0% 50%;}
      50% {background-position: 100% 50%;}
      100% {background-position: 0% 50%;}
    }

    #particles {
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      z-index: -2;
      pointer-events: none;
    }

    .container {
      display: flex;
      height: calc(100% - 50px);
      width: 100vw;
    }

    .left {
      position: relative;
      width: 68.6%;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    #ytVideo {
      flex: 1;
      width: 100%;
      border: none;
      border-bottom-right-radius: 20px;
    }

    #muteButton {
      position: fixed;
      bottom: 60px;
      right: 30px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: red;
      color: white;
      font-size: 24px;
      border: none;
      cursor: pointer;
      z-index: 10;
    }

    .info-row {
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 36px;
      gap: 180px;
      color: #fff;
      padding: 20px;
      z-index: 2;
    }

    .info-box {
      width: 200px;
      text-align: center;
    }

    .right {
      width: 31.4%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding-top: 200px;
    }

    .right img {
      position: absolute;
      top: 5px;
      width: 250px;
      z-index: 3;
    }

    .token-label {
      font-size: 70px;
      margin-bottom: 0.3em;
      font-weight: 500;
      padding-top: 50px;
    }

    .token-number {
      font-size: 280px;
      font-weight: 900;
      color: #ffffff;
      text-shadow: 0 0 15px #00ffff;
      margin-bottom: 20px;
    }

    .token-number.blink {
      animation: blink 0.6s ease-in-out 3;
    }

    .token-text { 
      font-size: 70px;
      margin-bottom: 0.3em;
      font-weight: 500;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }

    .footer {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: rgba(0, 0, 0, 0.2);
      color: #ffffff;
      font-size: 36px;
      overflow: hidden;
      white-space: nowrap;
      border-top: 2px solid black;
      z-index: 2;
    }

    .scroll-text {
      display: inline-block;
      padding-left: 100%;
      animation: scroll-left 30s linear infinite;
    }

    @keyframes scroll-left {
      0% { transform: translateX(0%); }
      100% { transform: translateX(-100%); }
    }
  </style>
</head>
<body>

<!-- Particle Canvas -->
<canvas id="particles"></canvas>

<div class="container">
  <div class="left">
    <div id="ytVideo"></div> <!-- YouTube IFrame will render here -->
    <button id="muteButton"><i class="fa-solid fa-volume-xmark"></i></button>

    <div class="info-row">
      <div class="info-box"><div>üå°Ô∏è</div><div id="temperature">--¬∞C</div></div>
      <div class="info-box"><div>üí®</div><div id="wind">-- km/h</div></div>
      <div class="info-box"><div id="dateClock">--:--</div><div id="dateAlt">-- --, ----</div></div>
    </div>
  </div>

  <div class="right">
    <img src="logo.png" alt="City Clinic Logo">
    <div class="token-label">Now serving</div>
    <div class="token-number" id="tokenNumber">--</div>
    <div class="token-text">Number</div>
  </div>
</div>

<div class="footer">
  <div class="scroll-text">
    üòÑ Welcome to City Clinic ‚Äì Kanavalli üè• ‚Ä¢ Opened Everyday ‚Ä¢ Morning 9:30‚Äì1:30 ‚Ä¢ Evening 6:30‚Äì10:30 ‚Ä¢ Stay healthy & safe! üíä
  </div>
</div>

<!-- YouTube Player API -->
<script src="https://www.youtube.com/iframe_api"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<!-- Floating Particle Script -->
<script>
  const canvas = document.getElementById('particles');
  const ctx = canvas.getContext('2d');
  let particles = [];

  function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  }
  resizeCanvas();
  window.addEventListener('resize', resizeCanvas);

  function createParticles(count) {
    for (let i = 0; i < count; i++) {
      particles.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        radius: Math.random() * 3 + 4,
        speedX: (Math.random() - 0.5) * 0.5,
        speedY: (Math.random() - 0.5) * 0.5,
      });
    }
  }

  function updateParticles() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    for (let p of particles) {
      p.x += p.speedX;
      p.y += p.speedY;

      if (p.x < 0 || p.x > canvas.width) p.speedX *= -1;
      if (p.y < 0 || p.y > canvas.height) p.speedY *= -1;

      ctx.beginPath();
      ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
      ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
      ctx.fill();
    }
    requestAnimationFrame(updateParticles);
  }

  createParticles(100);
  updateParticles();
</script>

<!-- Firebase Script -->
<script>
  // Firebase
  firebase.initializeApp({
    apiKey: "AIzaSyC-dN8RtQkDE3eY5q4mQUYiJv9xQCuwnsk",
    authDomain: "cityclinictoken.firebaseapp.com",
    databaseURL: "https://cityclinictoken-default-rtdb.firebaseio.com/",
    projectId: "cityclinictoken",
    storageBucket: "cityclinictoken.appspot.com",
    messagingSenderId: "196394231581",
    appId: "1:196394231581:web:08b59c5f22608a9246d6d5"
  });
  const database = firebase.database();

  let player, playerReady = false;
  const muteButton = document.getElementById('muteButton');
  const tokenEl = document.getElementById('tokenNumber');
  let lastToken = null, lastUpdate = null;
  let userInteracted = false;

  // Unlock audio after first click/tap
  function enableAudio() {
    if (!userInteracted) {
      userInteracted = true;
      console.log("User interaction detected ‚Äî audio allowed.");
      database.ref("videoMute").once("value").then(snap => {
        if (snap.val() === "UNMUTE" && playerReady) {
          player.unMute();
        }
      });
    }
  }
  document.body.addEventListener("click", enableAudio);
  document.body.addEventListener("touchstart", enableAudio);

  // Manual mute button (updates Firebase)
  muteButton.addEventListener("click", () => {
    database.ref("videoMute").once("value").then(snap => {
      const newState = (snap.val() === "MUTE") ? "UNMUTE" : "MUTE";
      database.ref("videoMute").set(newState);
    });
  });

  // YouTube API ready
  function onYouTubeIframeAPIReady() {
    database.ref('youtubeURL').on('value', (snapshot) => {
      const ytURL = snapshot.val();
      if (!ytURL) return;

      let videoId = "";
      if (ytURL.includes("youtu.be/")) {
        videoId = ytURL.split("youtu.be/")[1].split("?")[0];
      } else if (ytURL.includes("watch?v=")) {
        videoId = ytURL.split("watch?v=")[1].split("&")[0];
      } else {
        videoId = ytURL.trim();
      }

      if (!videoId) return;

      if (playerReady) {
        player.loadVideoById(videoId);
      } else {
        player = new YT.Player('ytVideo', {
          videoId: videoId,
          playerVars: { autoplay: 1, mute: 1, loop: 1, playlist: videoId, controls: 0, modestbranding: 1 },
          events: { 
            onReady: (event) => { 
              playerReady = true;
              event.target.playVideo();
            } 
          }
        });
      }
    });
  }

  // Mute/Unmute listener
  database.ref("videoMute").on("value", (snapshot) => {
    const muteState = snapshot.val();
    if (playerReady) {
      if (muteState === "MUTE") {
        player.mute();
        muteButton.innerHTML = '<i class="fa-solid fa-volume-xmark"></i>';
      } else if (muteState === "UNMUTE" && userInteracted) {
        player.unMute();
        player.setVolume(35); // default volume on unmute
        muteButton.innerHTML = '<i class="fa-solid fa-volume-high"></i>';
      }
    }
  });

  // Play/Pause listener
  database.ref("videoPlay").on("value", (snapshot) => {
    const playState = snapshot.val();
    if (playerReady) {
      if (playState === "PLAY") {
        player.playVideo();
      } else if (playState === "PAUSE") {
        player.pauseVideo();
      }
    }
  });

  // Volume listener (0‚Äì100 from Firebase)
  database.ref("videoVolume").on("value", (snapshot) => {
    const vol = parseInt(snapshot.val(), 10);
    if (playerReady && !isNaN(vol) && vol >= 0 && vol <= 100) {
      player.setVolume(vol);
    }
  });

  // Token change listener
let previousVolume = 30; // Default start volume

database.ref('currentToken').on('value', (snapshot) => {
  const data = snapshot.val();
  if (data) {
    const newToken = data.token || '--';
    const updatedAt = data.updatedAt || 0;

    if (lastToken !== newToken || lastUpdate !== updatedAt) {
      lastToken = newToken;
      lastUpdate = updatedAt;

      if (playerReady) {
        // Save current volume
        const currentVol = player.getVolume();
        previousVolume = currentVol > 0 ? currentVol : previousVolume;

        // Reduce volume to 5 for announcements
        player.setVolume(5);
      }

      // Play sounds
      if (userInteracted) {
        new Audio("bell.mp3").play();
        new Audio(`https://xon0176.github.io/CityClinicToken/tokensounds/${newToken}.mp3`).play();
      }

      // Restore volume after 5 seconds
      setTimeout(() => {
        if (playerReady) player.setVolume(previousVolume);
      }, 5000);

      // Blink token number
      tokenEl.classList.remove('blink'); void tokenEl.offsetWidth;
      tokenEl.classList.add('blink');
    }

    tokenEl.textContent = newToken;
  }
});

  // Clock  
  function updateTime() {
    const now = new Date();
    const time = now.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
    const dateAlt = now.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    document.getElementById("dateClock").textContent = time;
    document.getElementById("dateAlt").textContent = dateAlt;
  }
  setInterval(updateTime, 1000);
  updateTime();

  // Weather
  const apiKey = 'ece698c5756c98857c463ddc98000798';
  const city = 'Kanavalli';
  async function fetchWeather() {
    try {
      const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${apiKey}&units=metric`);
      const data = await res.json();
      document.getElementById("temperature").textContent = `${data.main.temp.toFixed(1)}¬∞C`;
      document.getElementById("wind").textContent = `${data.wind.speed.toFixed(1)} km/h`;
    } catch {
      document.getElementById("temperature").textContent = `--¬∞C`;
      document.getElementById("wind").textContent = `-- km/h`;
    }
  }
  fetchWeather();
  setInterval(fetchWeather, 600000);
</script>

</body>
</html>
